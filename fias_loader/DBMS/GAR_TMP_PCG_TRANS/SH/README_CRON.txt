--
--  2023-03-16  Описание установки   
--

Основные этапы:

0) Что делаем, для чего.
   Начальные условия: исполняемый  сценарий,   расписание CRONTAB

1) Исполняемый сценарий "load_updates.sh", описание предварительных настройки.

2) Что делаем после того, как файл отредактирован ?
   Помещаем его в "/usr/local/bin".
   
3) Как проверить его ??  Установить права на выполнение,
   Запустить руками, увидеть результаты.
   Прежде, чем запускать руками создать папку в "/var/log"
   Установить права на паку.
   Формат команды.
   
   Смотрим результат.  Вот так должна работать вся эта хренотень.
   
4) Создаём расписание для того профиля, под которым будет работать скрипт.

5) Всё, затихли. На следующий день смотрим результаты.

================================================================================================
Цель: Создать процесс выполняющий периодическое обновление адресной базы СРМ "Смородина Диалог",
      в качестве обновлений используются данные скачанные с адресного реестра ФНС.
      
Что необходимо для этого:

    1) BASH-скрипт "load_updates.sh".
    2) Расписание "crontab.txt".
        
Основные этапы установки:
    1) Отредактировать "load_updates.sh".
    2) Создать папку "/var/log/db_upgrade", установить владельца для "db_upgrade".
    3) Взять файл с очередными обновлениями и положить его в целевую папку.
    4) Запустить его из командной строки, убедиться в том, что обновление прошло
       успешно.
    5) Создать расписание для CRONTAB, положить очередное обновление в целевую папку.
       На следующий день просмотреть результаты обновления и убедииться в том, что 
       обновление прошло успешно.
================================================================================================       
Цель: Создать процесс выполняющий периодическое обновление адресной базы СРМ "Смородина Диалог",
      в качестве обновлений используются данные скачанные с адресного реестра ФНС.
      
Краткое описание:  Архив с обновления адресной базы помещается в целевую папку. Например:
      целевая папка "/tmp"?, архив "up_prds_20230206.tar.gz", имя архива строится по 
      конкретным правилам: "up_prds_" - префикс 
                           ".tar.gz"  - суффикс
                           "2023"     - год
                           "02"       - месяц
                          "06"        - дата
      Если изменить преффикс, либо суффикс, то процесс обновления не запустится.
                          
      Процесс обновления адресной базы должен запускаться один раз, в вечернее время.
      На следующий день состояние файлов в целевой папке изменится:
          - архив исчезнет
          - вместо него появятся два файла, содержащих протокол загрузки:
             
             "up_prds_20230306.out"
             "up_prds_20230306.err"
                  
      Ниже приведён фрагмент файла "up_prds_20230306.out"
      
                      DATA/adr_area_87.sql
                      BEGIN
                      DELETE 32
                      COPY 32
                      COMMIT
                      
                      DATA/adr_street_02.sql
                      BEGIN
                      DELETE 0
                      COPY 0
                      COMMIT
                      
                      DATA/adr_street_03.sql
                      BEGIN
                      DELETE 0
                      COPY 0
                      COMMIT
                      
                      DATA/adr_street_04.sql
                      BEGIN
                      DELETE 9
                      COPY 9
                      COMMIT
                           
      Сначала идут идут обновления адресных пространств, потом улиц, потом домов.
      Свидетельством того, что процесс обновления идёт правильно, является наличие пар 
      BEGIN -- COMMIT Если пояляется пара BEGIN -- ROLLBACK, то это означает, что для
      данного адресного региона (цифра в имени файла) обновление не было выполнено. 
      Причину ошибки можно посмотреть в файле типа "err".
      
      Ниже приведён фрагмент файла "up_prds_20230306.err"

                     Sat Mar 11 22:00:03 MSK 2023
                     DATA/adr_area_02.sql
                     DATA/adr_area_03.sql
                     DATA/adr_area_04.sql
                     DATA/adr_area_05.sql
                     DATA/adr_area_06.sql
                     DATA/adr_area_07.sql
                     DATA/adr_area_08.sql
                     DATA/adr_area_09.sql
                     DATA/adr_area_10.sql
                     DATA/adr_area_11.sql
                     DATA/adr_area_12.sql
                     DATA/adr_area_13.sql
                     DATA/adr_area_14.sql
      
      В обычном состоянии он содержит перечень обрботанных файлов с региональными обновлениями абресной базы. ВНИМАНИЕ номер адресного региона в имени файла соответствует стандартам
      адресной базы, они не совпадают с нумерацией регионов в адресном реестре ФНС.
      В том случаем, если в процессе обновления возникла ошибка, она зафиксируется в соот-
      ветствующем местей файла типа "err".
      
Установка:     
Настройка файла "load_updates.sh".  Она выполняется один раз, перед тем, как файл размещается
в каталоге "/usr/local/bin" и в дальнейшем используется для выполнения обновления обновления
адресной базы.

Таких боков два и они отмечены  комментариями

## ----------------------------------------------------- ##
##     Общие переменные устанавливать только вручную     ##
## ----------------------------------------------------- ##
WD=/tmp  # Рабочий каталог, сюда должен попасть архив с обновлениямим

Z5=$(ls /tmp/up_prds_*tar.gz.md5)

ZM=$(ls /tmp/up_prds_*tar.gz)
if [ $? -ne 0 ] 
  then
    exit 1
fi

# Маска имени архива ???
IP="_EXAMPLE_127.0.0.1"          # IP сервера БД
PT="_EXAMPLE_5432"               # Порт сервера БД
UM="_EXAMPLE_postgres"           # Имя пользователя БД
DB="_EXAMPLE_unnsi_prd"          # Имя базы
## ----------------------------------------------------- ##
##  УСТАНОВИТЬ И НЕ МЕНЯТЬ БЕЗ ОСОБОЙ НЕОБХОДИМОСТИМ     ##
## ----------------------------------------------------- ##

Обязательно необходимо установить значения для перемеменных IP, PT, UM, DB 
Для имени пользователя БД, необходимо создать запись в файле ".pgpass
Пользователь БД должен обладаь правами на выполнение операций типа CRUD.

Второй блок. Переменная ZD должна менять значения строго в соответствии с 
             значениями переменных Z5, ZM.

## ----------------------------------------------------- ##
##     Общие переменные устанавливать только вручную     ##
## ----------------------------------------------------- ##
ZD=$(ls -d /tmp/up_prds_202?????)    # Только каталоги.
if [ $? -ne 0 ] 
  then
    exit 1
fi
## ----------------------------------------------------- ##
##  УСТАНОВИТЬ И НЕ МЕНЯТЬ БЕЗ ОСОБОЙ НЕОБХОДИМОСТИМ     ##
## ----------------------------------------------------- ##
Далее файл размещается в папке "/usr/local/bin"? ему даются права
на выполнение для пользователя и его группы. Это неатель БД,
это пользователь систенмы, он имеет прва на выполнение скрипта,
на доступ к целевой папке, на доступ к "/var/log/db_upgrade"

$> chmod ug=+x+r+w /usr/local/bin/load_updates.sh

Создание папки для логгирования, папка получит владельца пользователя, для котрого
в дальнейшем будет создано расписание CRONTAB:

$> sudo mkdir /var/log/db_upgrade 
$>sudo chown <usr>.<usr_grp> /var/log/db_upgrade

И выполняем тестовый зпуск из командной строки.
Тестовый запуск

/usr/local/bin/load_updates.sh 1>> /var/log/db_upgrade/upgrade.out 2>> /var/log/db_upgrade/upgrade.err

создание расписания CRONTABю Расписание создаётся для пользователя <user1> включённого в группу 
<user1>

Приложен фалй "crontab.txt".

# Edit this file to introduce tasks to be run by cron.
# 
# Each task to run has to be defined through a single line
# indicating with different fields when the task will be run
# and what command to run for the task
# 
# To define the time you can provide concrete values for
# minute (m), hour (h), day of month (dom), month (mon),
# and day of week (dow) or use '*' in these fields (for 'any').# 
# Notice that tasks will be started based on the cron's system
# daemon's notion of time and timezones.
# 
# Output of the crontab jobs (including errors) is sent through
# email to the user the crontab file belongs to (unless redirected).
# 
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
# 
# For more information see the manual pages of crontab(5) and cron(8)
# 
# m h  dom mon dow   command
0 22 * * * /usr/local/bin/load_updates.sh 1>> /var/log/db_upgrade/upgrade.out 2>> /var/log/db_upgrade/upgrade.err

Т.е каждый день в 22-00 выполняется команда.
/usr/local/bin/load_updates.sh 1>> /var/log/db_upgrade/upgrade.out 2>> /var/log/db_upgrade/upgrade.err

$> crontab crontab.txt


